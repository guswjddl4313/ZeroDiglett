from flask import request

def is_admin(user):
    """사용자가 관리자인지 확인하는 함수"""
    return user.get("role") == "admin" if user else False

def sanitize_input(value):
    """입력값을 안전하게 정리하는 함수"""
    return value.strip() if value else ''

def has_valid_nonce():
    """POST 요청에 포함된 nonce 값 검증"""
    nonce = request.form.get('file_nonce') or request.form.get('export_nonce')
    return bool(nonce)  # 실제 환경에서는 nonce 검증 로직 추가 필요

def has_permission(user):
    """사용자 권한을 검사하는 함수"""
    
    # 관리자 여부 확인
    if not is_admin(user):
        return False, "Unauthorized: Admin access required"

    # GET 요청 검증 (설정 변경 감지)
    settings_updated = request.args.get('settings-updated')
    if settings_updated:
        return True, "✅ Settings update detected"

    # 파일 업로드 요청 검증
    if 'file' in request.files and has_valid_nonce():
        return True, "✅ File upload request verified"

    # Export 요청 검증
    if has_valid_nonce():
        return True, "✅ Export request verified"

    return False, "❌ Permission denied"

import os
import re
import json

# TO DO
# echo + sanitize_ ì“°ëŠ” ê²½ìš° > í•„í„°ë§ì´ ì—†ëŠ”ì§€
# echo + esc_ ì“°ëŠ” ê²½ìš° > ì¡°ê±´ì— ë§ê²Œ ì‚¬ìš©ëëŠ”ì§€

class XSS:
    def __init__(self, target_dir, result_dir):
        self.target_dir = target_dir
        self.result_dir = result_dir
        self.sanitize_methods = [
            "sanitize_text_field", "sanitize_email", "sanitize_file_name", "sanitize_html_class", 
            "sanitize_key", "sanitize_meta", "sanitize_mime_type", "sanitize_option", "sanitize_sql_orderby", 
            "sanitize_term", "sanitize_term_field", "sanitize_title", "sanitize_title_for_query", 
            "sanitize_title_with_dashes", "sanitize_user"
        ]
        self.escape_methods = {
            "html": "esc_html",
            "attr": "esc_attr",
            "url": "esc_url",
            "js": "esc_js",
            "textarea": "esc_textarea",
            "xml": "esc_xml",
            "json": "wp_json_encode",
            "kses": ["wp_kses", "wp_kses_post"]
        }
        
        # ê²°ê³¼ ì €ì¥ ë””ë ‰í„°ë¦¬ ìƒì„±
        os.makedirs(self.result_dir, exist_ok=True)

    # PHP ì½”ë“œì—ì„œ echoì™€ sanitize_ or esc_ ë©”ì„œë“œê°€ í•¨ê»˜ ì‚¬ìš©ëœ ë¼ì¸ì„ ì°¾ëŠ” í•¨ìˆ˜
    def check_php_security(self, file_path):
        with open(file_path, "r", encoding="utf-8") as f:
            code_lines = f.readlines()

        echo_sanitize_lines = []
        echo_escape_lines = []

        for i, line in enumerate(code_lines):
            if "echo" in line:
                if any(method in line for method in self.sanitize_methods):  
                    echo_sanitize_lines.append({
                        "file": file_path,
                        "line": i + 1,
                        "code": line.strip()
                    })

                for tag, methods in self.escape_methods.items():
                    if isinstance(methods, list):
                        escape_check = any(method in line for method in methods)
                    else:
                        escape_check = methods in line

                    if escape_check:
                        echo_escape_lines.append({
                            "file": file_path,
                            "line": i + 1,
                            "context": tag,
                            "code": line.strip()
                        })

        return echo_sanitize_lines, echo_escape_lines

    # ì§€ì •ëœ í´ë” ë‚´ ëª¨ë“  PHP íŒŒì¼ ê²€ì‚¬
    def scan_php_directory(self):
        sanitize_results = []
        escape_results = []

        for root, _, files in os.walk(self.target_dir):
            for file in files:
                if file.endswith(".php"):
                    file_path = os.path.join(root, file)
                    sanitize_lines, escape_lines = self.check_php_security(file_path)
                    sanitize_results.extend(sanitize_lines)
                    escape_results.extend(escape_lines)

        return sanitize_results, escape_results

    # ê²°ê³¼ ì €ì¥ ë° ì¶œë ¥
    def save_results(self, results, filename):
        output_file = os.path.join(self.result_dir, filename)
        with open(output_file, "w", encoding="utf-8") as f:
            json.dump(results, f, indent=4)
        print(f"ğŸ” ê²€ì‚¬ ì™„ë£Œ! ê²°ê³¼ê°€ {output_file} íŒŒì¼ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.")

    # ì‹¤í–‰ í•¨ìˆ˜
    def run_scan(self):
        print(f"[*] {self.target_dir} ë””ë ‰í„°ë¦¬ì—ì„œ XSS ê²€ì‚¬ ì‹¤í–‰...")
        sanitize_results, escape_results = self.scan_php_directory()

        if sanitize_results:
            print("âš ï¸ [ì£¼ì˜] echoì™€ sanitize_ ë©”ì„œë“œê°€ í•¨ê»˜ ì‚¬ìš©ëœ ì½”ë“œ:")
            for line_info in sanitize_results:
                print(f"ğŸ“Œ [ì·¨ì•½ ê°€ëŠ¥ì„± ìˆìŒ] {line_info['file']} (ë¼ì¸ {line_info['line']}):")
                print(f"   ì½”ë“œ: {line_info['code']}\n")
            self.save_results(sanitize_results, "echo_sanitize_lines.json")
        else:
            print("âœ… echoì™€ sanitize_ ë©”ì„œë“œê°€ í•¨ê»˜ ì“°ì¸ ì½”ë“œê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")

        if escape_results:
            print("âš ï¸ [í™•ì¸ í•„ìš”] echoì™€ esc_ ë©”ì„œë“œê°€ ì‚¬ìš©ëœ ì½”ë“œ:")
            for line_info in escape_results:
                print(f"ğŸ“Œ [ì»¨í…ìŠ¤íŠ¸: {line_info['context']}] {line_info['file']} (ë¼ì¸ {line_info['line']}):")
                print(f"   ì½”ë“œ: {line_info['code']}\n")
            self.save_results(escape_results, "echo_escape_lines.json")
        else:
            print("âœ… echoì™€ esc_ ë©”ì„œë“œê°€ í•¨ê»˜ ì“°ì¸ ì½”ë“œê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.")
